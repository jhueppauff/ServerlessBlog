@page "/"

@using Microsoft.AspNetCore.Authorization;
@using System.Reflection;
@using EditorNG.Models;
@using System;
@inject BlogClient blogClient;
@inject IJSRuntime JSRuntime;
@inject IDialogService DialogService;

@attribute [Authorize]

<a href="/add" class="btn btn-success"><span class="glyphicon glyphicon-plus-sign"></span> Add</a>
<button @onclick="@Refresh" class="btn btn-success"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>

@if (posts != null)
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                @foreach (PropertyInfo propertyInfo in posts[0].GetType().GetProperties())
                {
                    @if (propertyInfo.Name != "PartitionKey" && propertyInfo.Name != "RowKey" && propertyInfo.Name !=
                   "ImageUrl")
                    {
                        <th>@propertyInfo.Name</th>
                    }
                }
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (PostMetadata post in posts)
            {
                <tr>
                    @foreach (PropertyInfo propertyInfo in post.GetType().GetProperties())
                    {
                        @if (propertyInfo.Name != "PartitionKey" && propertyInfo.Name != "RowKey" && propertyInfo.Name !=
                       "ImageUrl")
                        {
                            <td>@propertyInfo.GetValue(post)</td>
                        }
                    }
                    <td>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@((e) => DeletePost(post))">Delete</MudButton>
                       @* <MudButton @onclick="@(() => DeletePost(post))" Variant="Variant.Filled" Color="Color.Error">Delete</MudButton>*@
                        @*<button @onclick="@(() => Delete(post))" class="btn btn-danger"><span
                        class="glyphicon glyphicon-remove-sign"></span> Delete</button>*@
                        @if (!post.IsPublic)
                        {
                            <button @onclick="() => ShowPublishOption(post)" class="btn btn-success">
                                <span class="glyphicon glyphicon-send"></span> Publish
                             </button>
                        }
                        <a href=@($"/Edit/{post.Slug}") Match="NavLinkMatch.All" class="btn btn-info"><span
                        class="glyphicon glyphicon-edit"></span> Edit</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Loading ...</p>
}

<ModalDialog @ref="modal">
    <Title>Publish Dialog</Title>

    <Body>
        <MudDatePicker PickerVariant="PickerVariant.Dialog" Label="Select Publish Date" @bind-Date="@publishDate" />
    </Body>
    <Footer>
        <button type="button" class="btn btn-primary" @onclick="@(() => Publish())">Publish</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal"
            @onclick="() => modal.Close()">Close</button>
    </Footer>
</ModalDialog>

@code {
    private ModalDialog modal { get; set; }
    private DateTime? publishDate = DateTime.Now;
    private string selectedPost;
    private List<PostMetadata> posts;

    protected override async Task OnInitializedAsync()
    {
        await Refresh();

        var pageViews = await blogClient.GetPageViewsAsync();

        foreach (var pageView in pageViews)
        {
            var post = posts.FirstOrDefault(x => x.PartitionKey == pageView.Slug);

            if (post != null)
            {
                post.Views = pageView.Views;
            }
        }
    }

    private async Task DeletePost(PostMetadata post)
    {
        var parameters = new DialogParameters { ["post"] = post };

        var dialog = DialogService.Show<DeleteBlogPostDialog>("Delete Post", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            await blogClient.DeleteBlogPostAsync(post);
            await Refresh();
        }
    }

    private async Task Refresh()
    {
        posts = await blogClient.GetBlogPostsAsync();
    }

    private void ShowPublishOption(PostMetadata post)
    {
        selectedPost = post.Slug;
        modal.Open();
    }

    private async Task Publish()
    {
        await blogClient.PublishPostAsync(selectedPost, publishDate ?? DateTime.UtcNow);
        modal.Close();
    }
}